"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = runMigration;
const uuid_1 = require("uuid");
const dashboard_1 = require("../src/shared/dashboard");
/* eslint-disable actual/typography */
async function runMigration(db) {
    db.transaction(() => {
        const reports = db.runQuery('SELECT id FROM custom_reports WHERE tombstone = 0 ORDER BY name COLLATE NOCASE ASC', [], true);
        db.execQuery(`
      CREATE TABLE dashboard
        (id TEXT PRIMARY KEY,
         type TEXT,
         width INTEGER,
         height INTEGER,
         x INTEGER,
         y INTEGER,
         meta TEXT,
         tombstone INTEGER DEFAULT 0);
    `);
        if (reports.length === 0) {
            dashboard_1.DEFAULT_DASHBOARD_STATE.forEach(widget => {
                db.runQuery(`INSERT INTO dashboard (id, type, width, height, x, y, meta) VALUES (?, ?, ?, ?, ?, ?, ?)`, [
                    (0, uuid_1.v4)(),
                    widget.type,
                    widget.width,
                    widget.height,
                    widget.x,
                    widget.y,
                    widget.meta !== undefined && widget.meta !== null
                        ? JSON.stringify(widget.meta)
                        : null,
                ]);
            });
            return;
        }
        db.execQuery(`
      INSERT INTO dashboard (id, type, width, height, x, y)
      VALUES
        ('${(0, uuid_1.v4)()}', 'net-worth-card', 8, 2, 0, 0),
        ('${(0, uuid_1.v4)()}', 'cash-flow-card', 4, 2, 8, 0),
        ('${(0, uuid_1.v4)()}', 'spending-card', 4, 2, 0, 2);
    `);
        // Add custom reports to the dashboard
        reports.forEach((report, id) => {
            db.runQuery(`INSERT INTO dashboard (id, type, width, height, x, y, meta) VALUES (?, ?, ?, ?, ?, ?, ?)`, [
                (0, uuid_1.v4)(),
                'custom-report',
                4,
                2,
                (id * 4) % 12,
                2 + Math.floor(id / 3) * 2,
                JSON.stringify({ id: report.id }),
            ]);
        });
    });
}
